package rest;
import java.sql.*;
import java.io.*; 

import javax.ws.rs.GET;
import javax.ws.rs.core.Context;
import javax.ws.rs.FormParam;
import javax.ws.rs.Produces;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.core.Response;
import javax.servlet.http.*;
import java.net.URI;
import javax.ws.rs.core.MediaType;
import javax.inject.Inject;
import java.util.Date;
import java.util.ArrayList;
import java.text.SimpleDateFormat;
import java.text.ParseException;

@Path(Config.app_url)
public class SnakeApp{

    public final class PassStatus{
        public static final int PASS_CHANGE_OK     = 0;
        public static final int PASS_CHANGE_FAILED = 1;
        public static final int PASS_IDLE = -1;
    }

    @Context
    private HttpServletRequest request;
    
	@Context
	private HttpServletResponse response;
    
    @Inject
    private SystemCore sc;

    @GET
    public void renderApp() throws Exception
    {
        HttpSession session = request.getSession(false);
        if(session == null)
        {
            response.sendRedirect(Config.getLoginUrl());
            return;
        }
<<<<<<< HEAD
        requestSetAttributes(32.7, 37.6, PassStatus.PASS_IDLE);
        request.getRequestDispatcher(Config.snake_page)
               .forward(request, response);
    }
    void requestSetAttributes(double tmp, double hum, int pass_stat)
    {
        request.setAttribute("temp_in",      tmp);
        request.setAttribute("humidity_out", hum);
        request.setAttribute("response_msg", pass_stat);
    }

    @POST
    public void changeUserPassword(
		@FormParam("old_pass") String o_password, 
		@FormParam("new_pass") String n_password, 
		@FormParam("new_pass_repeated") String r_password) 
        throws Exception
    {
        HttpSession session = request.getSession(false);
        if(session == null)
        {
            response.sendRedirect(Config.getLoginUrl());
            return;
        }
        // checkc if old password is correct
        UserDescriptor u =(UserDescriptor)session.getAttribute("user_info");
        Class.forName("org.mariadb.jdbc.Driver");
        Connection conn = DriverManager.getConnection("jdbc:mariadb://localhost:3306/pwr_snake", "wind", "alamakota");
        PreparedStatement stmt = conn.prepareStatement("select * from Users where login=? and pass_hash=?");
        String pass_hash = Sha256.toHexString(Sha256.getSHA(o_password)); 
        String login = u.getuserlogin(); 
        stmt.setString(1, login);
        stmt.setString(2, pass_hash);
        ResultSet res = stmt.executeQuery();
        if(!res.next())
        {
            requestSetAttributes(32.7, 37.6, PassStatus.PASS_CHANGE_FAILED);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }
        // new passwords match?
        if(!n_password.equals(r_password))  
        {
            requestSetAttributes(32.7, 37.6, PassStatus.PASS_CHANGE_FAILED);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }
        
        // update new password
        stmt = conn.prepareStatement("UPDATE Users SET pass_hash=? WHERE login=?");
        pass_hash = Sha256.toHexString(Sha256.getSHA(n_password)); 

        stmt.setString(1, pass_hash);
        stmt.setString(2, login);
        int rowsUpdated = stmt.executeUpdate();
        if(rowsUpdated == 0)
        {
            requestSetAttributes(32.7, 37.6, PassStatus.PASS_CHANGE_FAILED);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }

        requestSetAttributes(32.7, 37.6, PassStatus.PASS_CHANGE_OK);
=======
        UserDescriptor u =(UserDescriptor)session.getAttribute("user_info");
        appSetAttributes(PassStatus.PASS_IDLE, u);
>>>>>>> origin/edit_page_servlet
        request.getRequestDispatcher(Config.snake_page)
               .forward(request, response);
        return;
    }

    void appSetAttributes(int pass_status, UserDescriptor u)
    {
        LaboratoryState l = sc.getLabState();
        request.setAttribute("u_info",       u);
        request.setAttribute("active_users", l.loggedUsers);
        request.setAttribute("temp_in",      l.temperature);
        request.setAttribute("humidity_out", l.humidity);
        request.setAttribute("response_msg", pass_status);
    }

    @POST
    public void changeUserPassword(
		@FormParam("old_pass") String o_password, 
		@FormParam("new_pass") String n_password, 
		@FormParam("new_pass_repeated") String r_password) 
        throws Exception
    {
        HttpSession session = request.getSession(false);
        if(session == null)
        {
            response.sendRedirect(Config.getLoginUrl());
            return;
        }
        // checkc if old password is correct
        UserDescriptor u =(UserDescriptor)session.getAttribute("user_info");
        Class.forName("org.mariadb.jdbc.Driver");
        Connection conn = DriverManager.getConnection("jdbc:mariadb://localhost:3306/pwr_snake", "wind", "alamakota");
        PreparedStatement stmt = conn.prepareStatement("select * from Users where login=? and pass_hash=?");
        String pass_hash = Sha256.toHexString(Sha256.getSHA(o_password)); 
        String login = u.getuserlogin(); 
        stmt.setString(1, login);
        stmt.setString(2, pass_hash);
        ResultSet res = stmt.executeQuery();
        if(!res.next())
        {
            appSetAttributes(PassStatus.PASS_CHANGE_FAILED,u);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }
        // new passwords match?
        if(!n_password.equals(r_password))  
        {
            appSetAttributes(PassStatus.PASS_CHANGE_FAILED,u);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }
        
        // update new password
        stmt = conn.prepareStatement("UPDATE Users SET pass_hash=? WHERE login=?");
        pass_hash = Sha256.toHexString(Sha256.getSHA(n_password)); 

        stmt.setString(1, pass_hash);
        stmt.setString(2, login);
        int rowsUpdated = stmt.executeUpdate();
        if(rowsUpdated == 0)
        {
            appSetAttributes(PassStatus.PASS_CHANGE_FAILED,u);
            request.getRequestDispatcher(Config.snake_page)
                   .forward(request, response);
            return;
        }

        appSetAttributes(PassStatus.PASS_CHANGE_OK, u);
        request.getRequestDispatcher(Config.snake_page)
               .forward(request, response);
        return;
    }

    @GET
    @Path(Config.logout_url)
    public Response logout() throws Exception
    {
        HttpSession session = request.getSession(false);
        if(session == null)
        {
            URI uri = new URI(Config.getLoginUrl());
            return Response.seeOther(uri).build();
        }

        URI uri = new URI(Config.logout_url);
        return Response.seeOther(uri).build();
    }
};
